package com.datical.hammer.core.sqlrules

import com.datical.db.project.Project;
import com.datical.hammer.core.rules.Response;
import com.datical.hammer.core.rules.Response.ResponseType;
import com.datical.hammer.core.rules.WithComments;
import com.datical.hammer.core.rules.WithoutComments;
import com.datical.hammer.core.forecast.rules.RuleFunctions;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

function boolean hasSelectStar(String mySql)
{
		boolean itMatched = false;
		Pattern pattern1 = Pattern.compile("\\s+");
		Matcher matcher1 = pattern1.matcher(mySql) ;
	    String mySql1 =  matcher1.replaceAll(" ").toLowerCase().toString();
		Pattern pSelectStar = Pattern.compile("select (([^*]|.*)\\*((?:!\bfrom\b)|.*)from)");
		
		for (String newSQl : mySql1.split("select")) {
		  Matcher mSelectStar = pSelectStar.matcher( "select "+newSQl.trim() );
			while(mSelectStar.find()) 
			{
				String comments =mSelectStar.group();
				System.out.println("Found Statement : "+comments );
				itMatched = true;
			}
		}
		return itMatched;
}

	
rule " Code with Select * "
    salience 1
    when
        wc : WithoutComments(hasSelectStar(getText())) 
    then
 		String errorMessage =  "\n File " + wc.getSqlFile().getName() + " Contains Select * Statement ";
        insert(new Response(ResponseType.WARN, errorMessage, drools.getRule().getName()));
end
