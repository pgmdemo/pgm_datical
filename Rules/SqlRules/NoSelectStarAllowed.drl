/*
@author Kevin Chappell
@version 1.0
@date December 16, 2016
@description Error when tables are missing a schema name designation
*/
package com.datical.hammer.core.sqlrules

import com.datical.db.project.Project;
import com.datical.hammer.core.rules.Response;
import com.datical.hammer.core.rules.Response.ResponseType;
import com.datical.hammer.core.rules.WithComments;
import com.datical.hammer.core.rules.WithoutComments;
import com.datical.hammer.core.forecast.rules.RuleFunctions;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

function boolean hasSelectStar(String mySql)
{
		Pattern pattern1 = Pattern.compile("\\s+");
		Matcher matcher1 = pattern1.matcher(mySql) ;
	   System.out.println("Validation called For : "+ matcher1.replaceAll(" ").toLowerCase().toString());

	    Pattern pSelectStar = Pattern.compile("select *\\* ",Pattern.CASE_INSENSITIVE);
		Matcher mSelectStar = pSelectStar.matcher( matcher1.replaceAll(" ").toLowerCase().toString());
		
	    if ( mSelectStar.matches() ) { 
		 System.out.println(" Pattern Matched ");
			while(mSelectStar.find()) 
			{
				String comments =mSelectStar.group();
				System.out.println("Matched String : " + comments);
			}
		 return true;
		} else {
		 System.out.println("No Match Found");
		 return false;
		}
}

	
rule " Code with Select * in it "
    salience 1
    when
        wc : WithoutComments(hasSelectStar(getText())) 
    then
 		String errorMessage =  "\n File " + wc.getSqlFile().getName() + " Contains Select * Statement ";
        insert(new Response(ResponseType.FAIL, errorMessage, drools.getRule().getName()));
end
